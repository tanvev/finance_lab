{% extends "base.html" %}
{% load static %}
{% block title %}Loans Quiz | Educational Finance Lab{% endblock %}

{% block extra_head %}
<style>
@keyframes fl-confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
  20% { opacity: 1; }
  100% { transform: translateY(220px) rotate(360deg); opacity: 0; }
}
</style>

<script>
// -------------------------------
// 35-QUESTION MASTER BANK
// -------------------------------
const loansBank = [
  {
    text: "Two loans: A) 10.5% + ₹3,000 fee, B) 11% + zero fee. What matters most?",
    options: ["App design", "Lower EMI", "Total cost over full tenure", "Which loan starts later"],
    correct: 2,
    explanation: "Compare total cost = principal + interest + processing fee."
  },
  {
    text: "Paying only credit card minimum due repeatedly leads to:",
    options: ["Debt waived", "No interest", "Heavy interest on remaining amount", "Higher credit limit"],
    correct: 2,
    explanation: "Minimum due avoids late fee, not interest!"
  },
  {
    text: "Longer tenure usually means:",
    options: ["Small EMI, higher total interest", "Big EMI, zero interest", "Both small", "No impact"],
    correct: 0,
    explanation: "Lower EMI but more 'renting' of the money → more interest."
  },
  {
    text: "Best credit card habit:",
    options: ["Pay min due only", "Pay full amount every month", "Max out card", "Use loan to pay loan"],
    correct: 1,
    explanation: "Full payment avoids 30–40% interest traps."
  },
  {
    text: "Zero-cost EMI often means:",
    options: ["Free money", "Interest hidden in product price/discount", "Always cheaper", "No interest anywhere"],
    correct: 1,
    explanation: "Interest is often baked into MRP."
  },

  // 6–10
  {
    text: "Processing fee is:",
    options: ["Refundable", "Added to total loan cost", "Always optional", "Same as GST"],
    correct: 1,
    explanation: "Processing fee increases effective cost of borrowing."
  },
  {
    text: "Which impacts your credit score most?",
    options: ["App theme", "On-time payments", "Bank branch", "OTP sharing"],
    correct: 1,
    explanation: "Payment history is biggest factor."
  },
  {
    text: "If you close old credit card:",
    options: ["Score improves instantly", "Score may drop due to credit age reduction", "No effect", "Interest resets"],
    correct: 1,
    explanation: "Older card boosts average credit age."
  },
  {
    text: "Multiple loan applications in short time:",
    options: ["Great idea", "Harm credit score due to hard inquiries", "No effect", "Increase limit"],
    correct: 1,
    explanation: "Hard inquiries signal desperation."
  },
  {
    text: "Debt-to-income ratio high means:",
    options: ["Bank will approve easily", "You are over-leveraged", "Better offers", "Loan guaranteed"],
    correct: 1,
    explanation: "High DTI limits borrowing ability."

  },

  // 11–15
  {
    text: "Prepayment of loan early in tenure saves:",
    options: ["Nothing", "A lot of interest", "Only EMI count", "Bonus points"],
    correct: 1,
    explanation: "Interest is front-loaded; early prepayment saves big."
  },
  {
    text: "Some banks charge foreclosure fee for:",
    options: ["Paying loan early", "Paying late", "Opening account", "Checking statement"],
    correct: 0,
    explanation: "Foreclosure fee applies when closing loan early."
  },
  {
    text: "If credit utilization > 50%, score:",
    options: ["Goes up", "Drops", "Unaffected", "Doubles"],
    correct: 1,
    explanation: "High usage = high risk = score drop."
  },
  {
    text: "Co-signing someone’s loan means:",
    options: ["Only they are liable", "You are equally responsible", "Legal but risk-free", "Improves your score automatically"],
    correct: 1,
    explanation: "If they default, YOU must repay."
  },
  {
    text: "Loan EMI formula depends mainly on:",
    options: ["Tenure + interest rate", "Loan color", "Bank logo", "Name spelling"],
    correct: 0,
    explanation: "EMI = principal, rate, tenure."
  },

  // 16–20
  {
    text: "Balance transfer helps when:",
    options: ["To avoid paying", "Lower interest at another bank", "Credit limit increases", "Monthly budget low"],
    correct: 1,
    explanation: "Switch to cheaper lender to reduce cost."
  },
  {
    text: "Which loan is usually cheapest?",
    options: ["Personal loan", "Credit card EMI", "Home loan", "Short-term loan apps"],
    correct: 2,
    explanation: "Home loans have collateral → lower risk → lower rates."
  },
  {
    text: "Loan apps demanding contact access can result in:",
    options: ["Personalized service", "Harassment if you delay", "Higher score", "Bonus"],
    correct: 1,
    explanation: "Predatory apps misuse contacts for threats."
  },
  {
    text: "Missing EMI impacts score for:",
    options: ["1 month only", "Up to 7 years", "2 days", "Forever"],
    correct: 1,
    explanation: "Late payments stay in credit report for years."
  },
  {
    text: "Which is true about secured loans?",
    options: ["Higher rate", "Lower risk → lower rate", "Always illegal", "Not linked to collateral"],
    correct: 1,
    explanation: "Secured loans cost less due to collateral."

  },

  // 21–30
  {
    text: "Credit cards charge interest when:",
    options: ["You pay full amount", "You pay min due only", "You never use card", "You negotiate"],
    correct: 1,
    explanation: "Min due avoids penalty but interest still applies."
  },
  {
    text: "Loan rejection reason can be:",
    options: ["Good score", "High DTI ratio", "Stable income", "Correct KYC"],
    correct: 1,
    explanation: "Banks avoid overly leveraged borrowers."
  },
  {
    text: "If your EMI is >40% of salary:",
    options: ["Safe", "Risky financial position", "Best for tax", "Score improves"],
    correct: 1,
    explanation: "Banks expect EMI ≤ 30–35% of net income."
  },
  {
    text: "Overdraft facility allows:",
    options: ["Negative balance within limit", "Free money", "Auto loan approval", "Unlimited withdrawals"],
    correct: 0,
    explanation: "Overdraft lets you withdraw more than balance (with interest)."
  },
  {
    text: "EMI bounce penalty includes:",
    options: ["Only GST", "Late fee + bank charges", "Cashback loss", "Nothing"],
    correct: 1,
    explanation: "Bouncing EMI triggers two charges."
  },
  {
    text: "Top-up loan works when:",
    options: ["You want credit card", "Existing loan in good standing", "Bad score", "Tenure ends"],
    correct: 1,
    explanation: "Banks offer more credit if repayment track record is good."
  },
  {
    text: "CIBIL score range:",
    options: ["0–100", "300–900", "1000–1500", "-100 to +100"],
    correct: 1,
    explanation: "Indian credit scores range 300–900."
  },
  {
    text: "Score of 760+ means:",
    options: ["Excellent", "Poor", "Unusable", "Fraud alert"],
    correct: 0,
    explanation: "760+ gets best offers."
  },
  {
    text: "If loan interest is floating:",
    options: ["Rate can change", "Rate fixed forever", "No effect", "No link to repo rate"],
    correct: 0,
    explanation: "Floating → linked to RBI repo rate."
  },
  {
    text: "Lenders check bank statements for:",
    options: ["Spelling errors", "Income stability & spending habits", "Your location", "App usage"],
    correct: 1,
    explanation: "Cashflow patterns matter."
  },

  // 31–35
  {
    text: "Payday loan apps typically charge:",
    options: ["Low interest", "Extremely high hidden charges", "Zero fees", "Government rates"],
    correct: 1,
    explanation: "High APR disguised as convenience."
  },
  {
    text: "Loan eligibility improves when:",
    options: ["Salary increases", "You apply daily", "You use all credit", "You close FD"],
    correct: 0,
    explanation: "Higher income = higher repayment ability."
  },
  {
    text: "If you dispute a credit report error:",
    options: ["Ignoring is fine", "Raise dispute with bureau", "Go to bank physically only", "Pay fee"],
    correct: 1,
    explanation: "Bureaus must investigate disputes."
  },
  {
    text: "Credit card rewards matter only if:",
    options: ["You revolve balance", "You pay in full monthly", "You withdraw cash", "You take EMI always"],
    correct: 1,
    explanation: "Rewards → best only when interest = zero."
  },
  {
    text: "Debt avalanche strategy focuses on:",
    options: ["Smallest loan", "Highest interest loan first", "Longest tenure", "Credit card closing"],
    correct: 1,
    explanation: "Paying highest-interest debt first saves money."
  }
];


// -------------------------------
// Utility
// -------------------------------
function pickRandom5(arr) {
  return [...arr].sort(() => Math.random() - 0.5).slice(0, 5);
}

let quiz = [], idx = 0, score = 0, answered = {};

// -------------------------------
// Render Question
// -------------------------------
function renderQ() {
  const q = quiz[idx];

  document.getElementById("q-text").textContent = q.text;
  document.getElementById("q-counter").textContent = `Question ${idx+1} of ${quiz.length}`;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;

  const box = document.getElementById("q-options");
  box.innerHTML = "";
  document.getElementById("q-feedback").classList.add("hidden");
  document.getElementById("q-warning").classList.add("hidden");

  q.options.forEach((op,i)=>{
    const b=document.createElement("button");
    b.className="w-full text-left px-3 py-2 rounded-md border border-gray-200 dark:border-gray-600 text-sm bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900";
    b.textContent=op; b.onclick=()=>handle(i,b); box.appendChild(b);
  });

  document.getElementById("q-prev").disabled = idx === 0;

  if (answered[idx]) restoreState();
}

function restoreState() {
  const q = quiz[idx];
  const fb = document.getElementById("q-feedback");

  document.querySelectorAll("#q-options button").forEach((b,i)=>{
    b.disabled = true;
    if (i === q.correct) b.classList.add("bg-green-200");
  });

  fb.classList.remove("hidden");
  fb.innerHTML = `<strong>Answered</strong> – ${q.explanation}`;
}

// -------------------------------
// Handle Answer
// -------------------------------
function handle(i, btn) {
  if (answered[idx]) return;

  const q = quiz[idx];
  const buttons = document.querySelectorAll("#q-options button");

  buttons.forEach(b => b.disabled = true);

  const correct = i === q.correct;
  if (correct) { score++; btn.classList.add("bg-green-200"); }
  else { btn.classList.add("bg-red-200"); buttons[q.correct].classList.add("bg-green-200"); }

  document.getElementById("q-feedback").classList.remove("hidden");
  document.getElementById("q-feedback").innerHTML =
    `<strong>${correct ? "Correct" : "Incorrect"}</strong> – ${q.explanation}`;

  answered[idx] = true;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;
}

// -------------------------------
// Navigation
// -------------------------------
function nextQ(){
  if(!answered[idx])
    return document.getElementById("q-warning").classList.remove("hidden");

  if(idx === quiz.length-1) return showResult();
  idx++; renderQ();
}

function prevQ(){
  if(idx > 0){ idx--; renderQ(); }
}

// -------------------------------
// Results + XP + Badges
// -------------------------------
function showResult(){
  document.getElementById("quiz-card").classList.add("hidden");
  document.getElementById("result-card").classList.remove("hidden");

  const percent = Math.round((score / quiz.length) * 100);
  document.getElementById("result-score").textContent =
    `You scored ${score} / ${quiz.length} (${percent}%).`;

  let level = "bronze";
  if (percent > 70) level = "gold";
  else if (percent > 40) level = "silver";

  localStorage.setItem("fl_badge_loans", level);

  // XP: +50 base + bonus
  let xp = Number(localStorage.getItem("fl_xp") || 0);
  xp += 50 + (level === "silver" ? 10 : level === "gold" ? 20 : 0);
  localStorage.setItem("fl_xp", xp);

  renderBadge(level);
  launchConfetti();
}

function renderBadge(level){
  const wrap=document.getElementById("badge-wrapper");
  wrap.innerHTML = `
    <svg viewBox="0 0 120 150" class="w-28 h-36">
      <defs>
        <linearGradient id="ig" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${level==="gold"?"#A9D957":level==="silver"?"#C9D1D9":"#C08A5B"}"/>
          <stop offset="100%" stop-color="${level==="gold"?"#6EA230":level==="silver"?"#8E99A8":"#8B5E3C"}"/>
        </linearGradient>
      </defs>
      <path d="M60 10 L95 25 L95 70 C95 95 80 120 60 135 C40 120 25 95 25 70 L25 25 Z"
        fill="url(#ig)" stroke="rgba(0,0,0,0.1)" stroke-width="2"/>
      <text x="60" y="95" text-anchor="middle" fill="white" font-size="14" font-weight="700">${level.toUpperCase()}</text>
    </svg>`;
}

function launchConfetti(){
  const c=document.getElementById("confetti-container");
  c.classList.remove("hidden");
  for(let i=0;i<40;i++){
    const p=document.createElement("div");
    p.style.cssText=
      `position:absolute;width:6px;height:3px;left:${Math.random()*100}%;
       top:-10px;background:#${Math.floor(Math.random()*999)};
       animation:fl-confetti-fall ${2+Math.random()}s ease-out forwards;`;
    c.appendChild(p);
  }
  setTimeout(()=>{c.innerHTML="";c.classList.add("hidden");},3000);
}

function restartQuiz(){
  idx=0;score=0;answered={};
  quiz=pickRandom5(loansBank);
  document.getElementById("result-card").classList.add("hidden");
  document.getElementById("quiz-card").classList.remove("hidden");
  renderQ();
}

// -------------------------------
// INIT
// -------------------------------
document.addEventListener("DOMContentLoaded",()=>{
  quiz = pickRandom5(loansBank);
  document.getElementById("q-next").onclick = nextQ;
  document.getElementById("q-prev").onclick = prevQ;
  renderQ();
});
</script>
{% endblock %}

{% block content %}

<section class="mb-6">
  <h1 class="text-2xl md:text-3xl font-semibold text-trust dark:text-blue-300">
    Loans & Credit– Quiz
  </h1>
  <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300 max-w-2xl">
    Test your understanding of EMI's, processing.
    Every attempt gives 5 questions.
  </p>
</section>

{% include "quiz_base.html" %}

{% endblock %}
