{% extends "base.html" %}
{% load static %}
{% block title %}Investment Quiz | Educational Finance Lab{% endblock %}

{% block extra_head %}
<style>
@keyframes fl-confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
  20% { opacity: 1; }
  100% { transform: translateY(220px) rotate(360deg); opacity: 0; }
}
</style>

<script>
// -------------------------------
// 35-QUESTION MASTER BANK
// -------------------------------
const BANK = [
  { text:"What does inflation do?", options:["Makes money grow","Reduces purchasing power","No effect","Doubles money"], correct:1, explanation:"If prices rise faster than your returns, value decreases." },
  { text:"Best tool for long-term wealth?", options:["Savings account","Equity mutual funds","Daily trading","UPI wallet"], correct:1, explanation:"Equity funds historically beat inflation." },
  { text:"SIP works best when?", options:["Rising","Falling","Volatile","All"], correct:3, explanation:"Cost averaging works best in volatility." },
  { text:"Need money in 1–2 years?", options:["Equity funds","Crypto","Debt/fixed-income","Penny stocks"], correct:2, explanation:"Short-term needs must be safe." },
  { text:"Which goal suits equity?", options:["Next month rent","Laptop in 2 months","Retirement","Emergency fund"], correct:2, explanation:"Equity requires long horizon." },

  { text:"Biggest SIP advantage?", options:["Timing market","Consistent long duration","Switching funds","Checking NAV daily"], correct:1, explanation:"Compounding + duration beats timing." },
  { text:"Flaw in 'invest during crashes only'?", options:["Crashes predictable","Timing impossible","Markets never crash","Timing beats SIP"], correct:1, explanation:"No one can time bottoms reliably." },
  { text:"NAV drops 10%. Don't:", options:["Panic sell","Review","Continue SIP","Think long-term"], correct:0, explanation:"Exiting during dips kills returns." },
  { text:"Least risky fund type?", options:["Small-cap","Mid-cap","Large-cap","Crypto"], correct:2, explanation:"Large-cap = more stable." },
  { text:"Goal is 12 years away?", options:["FD","Short-term debt","Equity MF","Savings account"], correct:2, explanation:"Equity suits long-term." },

  { text:"Expense ratio represents:", options:["Only manager salary","Yearly % cost","Entry fee","Tax"], correct:1, explanation:"Annual cost % reduces returns." },
  { text:"Why Index funds outperform?", options:["Luck","Low cost + exposure","Lazy managers","Timing markets"], correct:1, explanation:"Low cost + diversification." },
  { text:"ELSS lock-in?", options:["6m","1y","3y","5y"], correct:2, explanation:"ELSS = 3-year lock-in." },
  { text:"Inflation 6%, FD 5% → return?", options:["Positive","Zero","Negative","Infinite"], correct:2, explanation:"5–6 = -1% real return." },
  { text:"SIPs:", options:["Guarantee returns","Reduce timing risk","Beat inflation always","Never fall"], correct:1, explanation:"Reduce timing risk, not guarantee." },

  { text:"Best emergency fund?", options:["Equity","Crypto","Liquid/Savings","NPS"], correct:2, explanation:"Needs liquidity + safety." },
  { text:"Direct vs Regular fund?", options:["Direct has higher fee","Direct skips commission","Regular compounding higher","Direct pays agents"], correct:1, explanation:"Direct avoids commission → more returns." },
  { text:"PPF maturity?", options:["5y","10y","15y","3y"], correct:2, explanation:"PPF lock 15 yrs." },
  { text:"NPS allows:", options:["Anytime liquidity","Partial withdrawal rules","Fixed returns","100% equity"], correct:1, explanation:"Partial withdrawal only." },
  { text:"Why small-caps volatile?", options:["Illegal","Low liquidity + uncertain growth","Tax","Too big"], correct:1, explanation:"High risk + uncertain earnings." },

  { text:"2-year horizon avoid:", options:["Liquid","Savings","Short debt","Equity"], correct:3, explanation:"Equity = long-term only." },
  { text:"Guaranteed 4% bad because:", options:["Scam","Often < inflation","Tax high","Illegal"], correct:1, explanation:"4% < inflation." },
  { text:"SIP increase yearly:", options:["Flexi","Step-up","Exit load","Sweep"], correct:1, explanation:"Step-up increases SIP annually." },
  { text:"Exit load?", options:["When entering","Exiting early","Switching","Missing SIP"], correct:1, explanation:"Penalty for early exit." },
  { text:"NAV represents:", options:["Future value","# of stocks","Value per unit","Fund turnover"], correct:2, explanation:"Current value per unit." },

  { text:"SIP amount should be based on:", options:["Peer pressure","Trends","Goals & risk","Random"], correct:2, explanation:"Goal-based investing." },
  { text:"Market correction is:", options:["Permanent","Healthy temporary drop","Fraud","Recession"], correct:1, explanation:"Corrections 10–20% are normal." },
  { text:"High risk ≠ high return because:", options:["Risk-free exists","Possibility of loss ↑","Insurance","Timing certainty"], correct:1, explanation:"High risk may mean losses." },
  { text:"REIT invest in:", options:["Crypto","Gold","Commercial real estate","Insurance"], correct:2, explanation:"Real estate rent income." },
  { text:"Gold ETF better because:", options:["More shine","Tax-free","No storage + transparent","Guaranteed"], correct:2, explanation:"No making charges + easy trade." },

  { text:"ULIP poor because:", options:["Banned","High charges","Zero tax","Locked forever"], correct:1, explanation:"High costs eat returns." },
  { text:"Best asset 15+ years:", options:["FD","Gold","Equity","Savings"], correct:2, explanation:"Equity wins long-term." },
  { text:"Diversification:", options:["Increases risk","Reduces impact of bad asset","Guarantees profit","Beats inflation"], correct:1, explanation:"Spreads risk." },
  { text:"Retirement planning assumes:", options:["Expenses reduce","Inflation-adjusted expenses","Parents fund","No inflation"], correct:1, explanation:"Costs rise with inflation." },
  { text:"International funds add:", options:["Redundancy","Geographical diversification","Higher tax only","No benefit"], correct:1, explanation:"Reduces geo risk." }
];

// -------------------------------
// Utility
// -------------------------------
function pickRandom5(arr) {
  return [...arr].sort(() => Math.random() - 0.5).slice(0, 5);
}

let quiz = [], idx = 0, score = 0, answered = {};

// -------------------------------
// Render Question
// -------------------------------
function renderQ() {
  const q = quiz[idx];

  document.getElementById("q-text").textContent = q.text;
  document.getElementById("q-counter").textContent = `Question ${idx+1} of ${quiz.length}`;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;

  const box = document.getElementById("q-options");
  box.innerHTML = "";
  document.getElementById("q-feedback").classList.add("hidden");
  document.getElementById("q-warning").classList.add("hidden");

  q.options.forEach((op,i)=>{
    const b=document.createElement("button");
    b.className="w-full text-left px-3 py-2 rounded-md border border-gray-200 dark:border-gray-600 text-sm bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900";
    b.textContent=op; b.onclick=()=>handle(i,b); box.appendChild(b);
  });

  document.getElementById("q-prev").disabled = idx === 0;

  if (answered[idx]) restoreState();
}

function restoreState() {
  const q = quiz[idx];
  const fb = document.getElementById("q-feedback");

  document.querySelectorAll("#q-options button").forEach((b,i)=>{
    b.disabled = true;
    if (i === q.correct) b.classList.add("bg-green-200");
  });

  fb.classList.remove("hidden");
  fb.innerHTML = `<strong>Answered</strong> – ${q.explanation}`;
}

// -------------------------------
// Handle Answer
// -------------------------------
function handle(i, btn) {
  if (answered[idx]) return;

  const q = quiz[idx];
  const buttons = document.querySelectorAll("#q-options button");

  buttons.forEach(b => b.disabled = true);

  const correct = i === q.correct;
  if (correct) { score++; btn.classList.add("bg-green-200"); }
  else { btn.classList.add("bg-red-200"); buttons[q.correct].classList.add("bg-green-200"); }

  document.getElementById("q-feedback").classList.remove("hidden");
  document.getElementById("q-feedback").innerHTML =
    `<strong>${correct ? "Correct" : "Incorrect"}</strong> – ${q.explanation}`;

  answered[idx] = true;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;
}

// -------------------------------
// Navigation
// -------------------------------
function nextQ(){
  if(!answered[idx])
    return document.getElementById("q-warning").classList.remove("hidden");

  if(idx === quiz.length-1) return showResult();
  idx++; renderQ();
}

function prevQ(){
  if(idx > 0){ idx--; renderQ(); }
}

// -------------------------------
// Results + XP + Badges
// -------------------------------
function showResult(){
  document.getElementById("quiz-card").classList.add("hidden");
  document.getElementById("result-card").classList.remove("hidden");

  const percent = Math.round((score / quiz.length) * 100);
  document.getElementById("result-score").textContent =
    `You scored ${score} / ${quiz.length} (${percent}%).`;

  let level = "bronze";
  if (percent > 70) level = "gold";
  else if (percent > 40) level = "silver";

  localStorage.setItem("fl_badge_invest", level);

  // XP: +50 base + bonus
  let xp = Number(localStorage.getItem("fl_xp") || 0);
  xp += 50 + (level === "silver" ? 10 : level === "gold" ? 20 : 0);
  localStorage.setItem("fl_xp", xp);

  renderBadge(level);
  launchConfetti();
}

function renderBadge(level){
  const wrap=document.getElementById("badge-wrapper");
  wrap.innerHTML = `
    <svg viewBox="0 0 120 150" class="w-28 h-36">
      <defs>
        <linearGradient id="ig" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${level==="gold"?"#A9D957":level==="silver"?"#C9D1D9":"#C08A5B"}"/>
          <stop offset="100%" stop-color="${level==="gold"?"#6EA230":level==="silver"?"#8E99A8":"#8B5E3C"}"/>
        </linearGradient>
      </defs>
      <path d="M60 10 L95 25 L95 70 C95 95 80 120 60 135 C40 120 25 95 25 70 L25 25 Z"
        fill="url(#ig)" stroke="rgba(0,0,0,0.1)" stroke-width="2"/>
      <text x="60" y="95" text-anchor="middle" fill="white" font-size="14" font-weight="700">${level.toUpperCase()}</text>
    </svg>`;
}

function launchConfetti(){
  const c=document.getElementById("confetti-container");
  c.classList.remove("hidden");
  for(let i=0;i<40;i++){
    const p=document.createElement("div");
    p.style.cssText=
      `position:absolute;width:6px;height:3px;left:${Math.random()*100}%;
       top:-10px;background:#${Math.floor(Math.random()*999)};
       animation:fl-confetti-fall ${2+Math.random()}s ease-out forwards;`;
    c.appendChild(p);
  }
  setTimeout(()=>{c.innerHTML="";c.classList.add("hidden");},3000);
}

function restartQuiz(){
  idx=0;score=0;answered={};
  quiz=pickRandom5(BANK);
  document.getElementById("result-card").classList.add("hidden");
  document.getElementById("quiz-card").classList.remove("hidden");
  renderQ();
}

// -------------------------------
// INIT
// -------------------------------
document.addEventListener("DOMContentLoaded",()=>{
  quiz = pickRandom5(BANK);
  document.getElementById("q-next").onclick = nextQ;
  document.getElementById("q-prev").onclick = prevQ;
  renderQ();
});
</script>
{% endblock %}

{% block content %}

<section class="mb-6">
  <h1 class="text-2xl md:text-3xl font-semibold text-trust dark:text-blue-300">
    Investment Fundamentals – Quiz
  </h1>
  <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300 max-w-2xl">
    Test your understanding of compounding, SIPs, risk, goal planning & inflation.
    Every attempt gives 5 random questions from a 35-question master bank.
  </p>
</section>

{% include "quiz_base.html" %}

{% endblock %}
