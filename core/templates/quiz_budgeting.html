{% extends "base.html" %}
{% load static %}
{% block title %}Budgeting Quiz | Educational Finance Lab{% endblock %}

{% block extra_head %}
<style>
@keyframes fl-confetti-fall {
  0% { transform: translateY(-20px) rotate(0deg); opacity: 0; }
  20% { opacity: 1; }
  100% { transform: translateY(220px) rotate(360deg); opacity: 0; }
}
</style>

<script>
// -------------------------------
// 35-QUESTION MASTER BANK
// -------------------------------
const budgetBank = [
  {
    text: "50-30-20 rule means:",
    options: ["50 save, 30 rent, 20 travel", "50 needs, 30 wants, 20 savings", "50 fun, 30 food, 20 bills", "50 tax, 20 EMI"],
    correct: 1,
    explanation: "Classic budgeting split of needs/wants/savings."
  },
  {
    text: "Budget fails mostly because:",
    options: ["Bad maths", "No tracking of actual spending", "Bank mistake", "Apps crash"],
    correct: 1,
    explanation: "Tracking ensures awareness."
  },
  {
    text: "Emergency fund ideally is:",
    options: ["1 month expense", "3–6 months expense", "12 months expense", "Salary × 3"],
    correct: 1,
    explanation: "3–6 months acts as safety buffer."
  },
  {
    text: "If rent takes 60% of salary:",
    options: ["Normal", "Budget pressure high", "Best scenario", "Increases savings"],
    correct: 1,
    explanation: "Rent >40% strains finances."
  },
  {
    text: "Buying things on sale can still hurt budget if:",
    options: ["You need them", "They're essential", "It triggers impulsive buying", "They’re discounted"],
    correct: 2,
    explanation: "Discount psychology leads to overspending."
  },

  // 6–10
  {
    text: "Monthly subscriptions hurt budget because:",
    options: ["They're free", "They pile up invisibly", "They increase savings", "They’re one-time"],
    correct: 1,
    explanation: "Subscriptions accumulate & go unnoticed."
  },
  {
    text: "Good first step for budgeting:",
    options: ["Buy expensive tools", "Track expenses for 30 days", "Ask friends", "Reduce income"],
    correct: 1,
    explanation: "Know where money goes before planning."
  },
  {
    text: "Wants example:",
    options: ["Groceries", "Internet bill for work", "Movie outing", "Electricity"],
    correct: 2,
    explanation: "Wants ≠ essentials."
  },
  {
    text: "If salary irregular, budgeting should:",
    options: ["Ignore income", "Use average income + strict emergency fund", "Spend all", "Delay savings"],
    correct: 1,
    explanation: "Irregular pay demands stronger emergency planning."
  },
  {
    text: "Biggest leak in budgets:",
    options: ["Rent", "Random small daily expenses", "Tax", "PF deduction"],
    correct: 1,
    explanation: "Small costs add up silently."

  },

  // 11–20
  {
    text: "Credit card budgeting rule:",
    options: ["Ignore limit", "Treat credit card like debit card", "Spend all limit", "Pay min due"],
    correct: 1,
    explanation: "Spend only what you can pay in full."
  },
  {
    text: "Meal planning helps because:",
    options: ["Improves cooking only", "Reduces food waste + spending", "No effect", "Increases cost"],
    correct: 1,
    explanation: "Prevents impulsive ordering."
  },
  {
    text: "Zero-based budgeting means:",
    options: ["Zero income", "Every rupee assigned purpose", "Zero savings", "Zero tax"],
    correct: 1,
    explanation: "Everything must have a job."
  },
  {
    text: "Overspending often happens when:",
    options: ["Using cash", "Using UPI/cards frictionless", "Shopping rarely", "Tracking daily"],
    correct: 1,
    explanation: "Frictionless payments increase impulse purchases."
  },
  {
    text: "Your savings rate improves fastest by:",
    options: ["Cutting income", "Reducing discretionary spending", "Taking loans", "Buying gadgets"],
    correct: 1,
    explanation: "Discretionary spending is flexible."

  },
  {
    text: "If EMI is high, fix budget by:",
    options: ["Ignoring EMI", "Reducing wants drastically", "Stopping savings", "Loan default"],
    correct: 1,
    explanation: "When EMI is fixed, adjust wants first."
  },
  {
    text: "Ideal target savings rate early career:",
    options: ["1–5%", "10–20%", "0%", "50%"],
    correct: 1,
    explanation: "Start with 10–20% and increase."
  },
  {
    text: "Buying via BNPL (Buy Now Pay Later) risk:",
    options: ["Improve credit automatically", "Encourages overspending & hidden fees", "Always interest-free", "Best budgeting hack"],
    correct: 1,
    explanation: "BNPL hides real cost."
  },
  {
    text: "Tracking budget weekly helps because:",
    options: ["Too much effort", "Course correction before month ends", "No benefit", "Increases expenses"],
    correct: 1,
    explanation: "Earlier warnings prevent overshooting."
  },
  {
    text: "Try to save raises instead of:",
    options: ["Increasing lifestyle immediately", "Investing", "Paying rent", "Paying tax"],
    correct: 0,
    explanation: "Avoid lifestyle inflation."

  },

  // 21–30
  {
    text: "Income shock protection includes:",
    options: ["More wants", "Emergency fund + insurance", "New loans", "More credit cards"],
    correct: 1,
    explanation: "Safety nets help absorb shocks."
  },
  {
    text: "Sinking fund helps by:",
    options: ["Random saving", "Saving for predictable future expenses", "Increasing tax", "Budgeting only for rent"],
    correct: 1,
    explanation: "Used for planned expenses (travel, insurance)."
  },
  {
    text: "If you constantly overspend:",
    options: ["Increase awareness & reduce triggers", "Increase EMI", "Ignore it", "Stop saving"],
    correct: 0,
    explanation: "Identify root cause."
  },
  {
    text: "Cash envelopes help with:",
    options: ["Digital fraud", "Spending cap on categories", "Losing money", "Tax planning"],
    correct: 1,
    explanation: "Visual limitation reduces overspending."
  },
  {
    text: "Rent negotiation possible when:",
    options: ["Landlord strict", "Vacancy high in area", "Peak demand", "Festival time only"],
    correct: 1,
    explanation: "High vacancy → negotiation power."

  },
  {
    text: "Lifestyle creep happens when:",
    options: ["Income same", "Expenses grow faster than income", "Income falls", "Tax increases"],
    correct: 1,
    explanation: "Hidden enemy of long-term wealth."
  },
  {
    text: "First big financial goal for beginners:",
    options: ["Car purchase", "Emergency fund", "Foreign trip", "Credit card"],
    correct: 1,
    explanation: "Emergency fund builds stability."
  },
  {
    text: "A good budget:",
    options: ["Rigid & punishing", "Flexible & goal-based", "Random", "Copied from friend"],
    correct: 1,
    explanation: "Budgets should adapt to changes."
  },
  {
    text: "Cutting ₹100 daily helps save:",
    options: ["₹100", "₹3,000/month", "₹1,000/month", "Nothing"],
    correct: 1,
    explanation: "Small daily expenses add up massively."
  },
  {
    text: "Avoiding high EMI purchases helps because:",
    options: ["Less stress + more liquidity", "More debt", "Tax benefit always", "Free money"],
    correct: 0,
    explanation: "Lower EMI = more flexibility."

  },

  // 31–35
  {
    text: "Monthly review helps identify:",
    options: ["Only income", "Overspending patterns", "Tax errors", "Nothing"],
    correct: 1,
    explanation: "Patterns drive improvements."
  },
  {
    text: "Financial discipline improves when:",
    options: ["Tracking + automation", "Ignoring budget", "Copying others", "Only saving coins"],
    correct: 0,
    explanation: "Automation + tracking enforces habits."
  },
  {
    text: "Rent + EMI ideally should be under:",
    options: ["20%", "60%", "40-45%", "90%"],
    correct: 2,
    explanation: "Housing expenses should not cross ~40–45% of income."
  },
  {
    text: "Grocery overspending happens due to:",
    options: ["No list + impulsive buying", "Fixed prices", "Sales only", "Healthy food"],
    correct: 0,
    explanation: "Lists reduce impulse purchases."
  },
  {
    text: "Best budgeting advice at age 22:",
    options: ["Focus on savings rate early", "Delay investing", "Copy friend’s budget", "Spend all salary"],
    correct: 0,
    explanation: "Savings rate early determines long-term wealth."
  }
];


// -------------------------------
// Utility
// -------------------------------
function pickRandom5(arr) {
  return [...arr].sort(() => Math.random() - 0.5).slice(0, 5);
}

let quiz = [], idx = 0, score = 0, answered = {};

// -------------------------------
// Render Question
// -------------------------------
function renderQ() {
  const q = quiz[idx];

  document.getElementById("q-text").textContent = q.text;
  document.getElementById("q-counter").textContent = `Question ${idx+1} of ${quiz.length}`;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;

  const box = document.getElementById("q-options");
  box.innerHTML = "";
  document.getElementById("q-feedback").classList.add("hidden");
  document.getElementById("q-warning").classList.add("hidden");

  q.options.forEach((op,i)=>{
    const b=document.createElement("button");
    b.className="w-full text-left px-3 py-2 rounded-md border border-gray-200 dark:border-gray-600 text-sm bg-gray-50 dark:bg-gray-800 hover:bg-blue-50 dark:hover:bg-blue-900";
    b.textContent=op; b.onclick=()=>handle(i,b); box.appendChild(b);
  });

  document.getElementById("q-prev").disabled = idx === 0;

  if (answered[idx]) restoreState();
}

function restoreState() {
  const q = quiz[idx];
  const fb = document.getElementById("q-feedback");

  document.querySelectorAll("#q-options button").forEach((b,i)=>{
    b.disabled = true;
    if (i === q.correct) b.classList.add("bg-green-200");
  });

  fb.classList.remove("hidden");
  fb.innerHTML = `<strong>Answered</strong> – ${q.explanation}`;
}

// -------------------------------
// Handle Answer
// -------------------------------
function handle(i, btn) {
  if (answered[idx]) return;

  const q = quiz[idx];
  const buttons = document.querySelectorAll("#q-options button");

  buttons.forEach(b => b.disabled = true);

  const correct = i === q.correct;
  if (correct) { score++; btn.classList.add("bg-green-200"); }
  else { btn.classList.add("bg-red-200"); buttons[q.correct].classList.add("bg-green-200"); }

  document.getElementById("q-feedback").classList.remove("hidden");
  document.getElementById("q-feedback").innerHTML =
    `<strong>${correct ? "Correct" : "Incorrect"}</strong> – ${q.explanation}`;

  answered[idx] = true;
  document.getElementById("q-score").textContent = `Score: ${score} / ${quiz.length}`;
}

// -------------------------------
// Navigation
// -------------------------------
function nextQ(){
  if(!answered[idx])
    return document.getElementById("q-warning").classList.remove("hidden");

  if(idx === quiz.length-1) return showResult();
  idx++; renderQ();
}

function prevQ(){
  if(idx > 0){ idx--; renderQ(); }
}

// -------------------------------
// Results + XP + Badges
// -------------------------------
function showResult(){
  document.getElementById("quiz-card").classList.add("hidden");
  document.getElementById("result-card").classList.remove("hidden");

  const percent = Math.round((score / quiz.length) * 100);
  document.getElementById("result-score").textContent =
    `You scored ${score} / ${quiz.length} (${percent}%).`;

  let level = "bronze";
  if (percent > 70) level = "gold";
  else if (percent > 40) level = "silver";

  localStorage.setItem("fl_badge_budget", level);

  // XP: +50 base + bonus
  let xp = Number(localStorage.getItem("fl_xp") || 0);
  xp += 50 + (level === "silver" ? 10 : level === "gold" ? 20 : 0);
  localStorage.setItem("fl_xp", xp);

  renderBadge(level);
  launchConfetti();
}

function renderBadge(level){
  const wrap=document.getElementById("badge-wrapper");
  wrap.innerHTML = `
    <svg viewBox="0 0 120 150" class="w-28 h-36">
      <defs>
        <linearGradient id="ig" x1="0" y1="0" x2="0" y2="1">
          <stop offset="0%" stop-color="${level==="gold"?"#A9D957":level==="silver"?"#C9D1D9":"#C08A5B"}"/>
          <stop offset="100%" stop-color="${level==="gold"?"#6EA230":level==="silver"?"#8E99A8":"#8B5E3C"}"/>
        </linearGradient>
      </defs>
      <path d="M60 10 L95 25 L95 70 C95 95 80 120 60 135 C40 120 25 95 25 70 L25 25 Z"
        fill="url(#ig)" stroke="rgba(0,0,0,0.1)" stroke-width="2"/>
      <text x="60" y="95" text-anchor="middle" fill="white" font-size="14" font-weight="700">${level.toUpperCase()}</text>
    </svg>`;
}

function launchConfetti(){
  const c=document.getElementById("confetti-container");
  c.classList.remove("hidden");
  for(let i=0;i<40;i++){
    const p=document.createElement("div");
    p.style.cssText=
      `position:absolute;width:6px;height:3px;left:${Math.random()*100}%;
       top:-10px;background:#${Math.floor(Math.random()*999)};
       animation:fl-confetti-fall ${2+Math.random()}s ease-out forwards;`;
    c.appendChild(p);
  }
  setTimeout(()=>{c.innerHTML="";c.classList.add("hidden");},3000);
}

function restartQuiz(){
  idx=0;score=0;answered={};
  quiz=pickRandom5(budgetBank);
  document.getElementById("result-card").classList.add("hidden");
  document.getElementById("quiz-card").classList.remove("hidden");
  renderQ();
}

// -------------------------------
// INIT
// -------------------------------
document.addEventListener("DOMContentLoaded",()=>{
  quiz = pickRandom5(budgetBank);
  document.getElementById("q-next").onclick = nextQ;
  document.getElementById("q-prev").onclick = prevQ;
  renderQ();
});
</script>
{% endblock %}

{% block content %}

<section class="mb-6">
  <h1 class="text-2xl md:text-3xl font-semibold text-trust dark:text-blue-300">
    Budgeting Fundamentals – Quiz
  </h1>
  <p class="mt-2 text-sm md:text-base text-gray-700 dark:text-gray-300 max-w-2xl">
    Test your understanding of planninf, 50-30-20 rule.
    Every attempt gives 5 questions.
  </p>
</section>

{% include "quiz_base.html" %}

{% endblock %}
