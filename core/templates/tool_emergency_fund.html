{% extends "base.html" %}
{% block title %}Emergency Fund Calculator{% endblock %}

{% block content %}

<section class="grid grid-cols-1 lg:grid-cols-2 gap-8 mt-6">

  <!-- LEFT INPUT PANEL -->
  <div class="bg-white dark:bg-gray-800 rounded-lg p-8 shadow-md border dark:border-gray-700">
    <h2 class="text-2xl font-semibold text-trust dark:text-blue-300">Emergency Fund Calculator</h2>
    <p class="text-gray-700 dark:text-gray-300 text-base mt-2">
      Estimate how much you should keep aside for emergencies, and how long it might take to reach that safety buffer.
    </p>

    <form id="efForm" class="space-y-5 mt-8 text-base" onsubmit="return false;">

      <!-- Monthly Essential Expenses -->
      <div>
        <label class="block text-gray-700 dark:text-gray-200 font-medium">
          Monthly Essential Expenses (₹)
        </label>
        <input type="number" id="monthlyEssentials" min="1"
               class="w-full px-4 py-2.5 rounded-md border border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-900 dark:text-gray-100">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Only basics: rent, food, transport, utilities, essential EMIs.
        </p>
      </div>

      <!-- Safety Months -->
      <div>
        <label class="block text-gray-700 dark:text-gray-200 font-medium">
          Safety Buffer (Months)
        </label>
        <input type="number" id="safetyMonths" min="1" max="24" value="3"
               class="w-full px-4 py-2.5 rounded-md border border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-900 dark:text-gray-100">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Many planners suggest 3–6 months of essential expenses.
        </p>
      </div>

      <!-- Current Emergency Savings -->
      <div>
        <label class="block text-gray-700 dark:text-gray-200 font-medium">
          Current Emergency Savings (₹)
        </label>
        <input type="number" id="currentSavings" min="0" value="0"
               class="w-full px-4 py-2.5 rounded-md border border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-900 dark:text-gray-100">
      </div>

      <!-- Monthly Contribution -->
      <div>
        <label class="block text-gray-700 dark:text-gray-200 font-medium">
          Amount You Can Save Monthly (₹)
        </label>
        <input type="number" id="monthlySave" min="0" value="0"
               class="w-full px-4 py-2.5 rounded-md border border-gray-300 dark:border-gray-600
                      bg-gray-50 dark:bg-gray-900 dark:text-gray-100">
        <p class="text-sm text-gray-500 dark:text-gray-400 mt-1">
          Optional: helps estimate how many months you may need to reach the target.
        </p>
      </div>

      <!-- Button -->
      <button type="button" onclick="calculateEmergencyFund()"
        class="w-full px-6 py-2.5 rounded-md text-white bg-blue-600 hover:bg-blue-700
               dark:bg-blue-500 dark:hover:bg-blue-400 font-medium mt-4">
        Calculate Emergency Fund
      </button>
    </form>

    <!-- Note -->
    <div class="p-4 mt-6 bg-blue-50 dark:bg-blue-900 text-gray-900 dark:text-gray-100
                rounded-md border-l-4 border-blue-500 text-base">
      <strong>Tip:</strong> Start with a small target (for example, ₹ 10,000) and increase it gradually.
    </div>
  </div>

  <!-- RIGHT OUTPUT PANEL -->
  <div class="bg-white dark:bg-gray-800 rounded-lg p-8 shadow-md border dark:border-gray-700">
    <h3 class="text-xl font-semibold text-trust dark:text-blue-300">Safety Cushion Overview</h3>
    <p class="text-gray-700 dark:text-gray-300 text-base mt-1">
      Compare your current savings versus the target emergency fund.
    </p>

    <!-- Chart -->
    <canvas id="efChart" class="mt-6 w-full h-64"></canvas>

    <!-- Results Summary -->
    <div id="efSummary"
         class="hidden mt-8 space-y-2 text-base bg-blue-50 dark:bg-blue-900 border border-blue-300
                dark:border-blue-700 rounded-lg p-4">
      <p><strong>Target Emergency Fund:</strong> <span id="efTarget"></span></p>
      <p><strong>Current Savings:</strong> <span id="efCurrent"></span></p>
      <p><strong>Gap to Cover:</strong> <span id="efGap"></span></p>
      <p id="efTimeText" class="text-sm text-gray-700 dark:text-gray-300 mt-1"></p>
    </div>

  </div>
</section>

{% endblock %}

{% block extra_head %}
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
// Format as ₹ 1,20,000
function formatINR(amount) {
  return "₹ " + amount.toLocaleString("en-IN");
}

function calculateEmergencyFund() {
  const monthlyEss = parseFloat(document.getElementById("monthlyEssentials").value);
  const safetyMonths = parseFloat(document.getElementById("safetyMonths").value);
  const currentSavings = parseFloat(document.getElementById("currentSavings").value || 0);
  const monthlySave = parseFloat(document.getElementById("monthlySave").value || 0);

  if (!monthlyEss || !safetyMonths) {
    alert("Please fill Monthly Essentials and Safety Months.");
    return;
  }

  const target = monthlyEss * safetyMonths;
  const gap = Math.max(target - currentSavings, 0);

  // Update text values
  document.getElementById("efTarget").innerText = formatINR(Math.round(target));
  document.getElementById("efCurrent").innerText = formatINR(Math.round(currentSavings));
  document.getElementById("efGap").innerText = formatINR(Math.round(gap));

  let timeText = "";
  if (gap <= 0) {
    timeText = "You have already reached or exceeded your emergency fund target.";
  } else if (monthlySave > 0) {
    const monthsNeeded = gap / monthlySave;
    const roundedMonths = Math.ceil(monthsNeeded);
    const yearsPart = Math.floor(roundedMonths / 12);
    const remMonths = roundedMonths % 12;

    if (yearsPart > 0) {
      timeText = `If you save this amount every month, you could reach your target in about ${yearsPart} year(s)` +
                 (remMonths > 0 ? ` and ${remMonths} month(s).` : ".");
    } else {
      timeText = `If you save this amount every month, you could reach your target in about ${roundedMonths} month(s).`;
    }
  } else {
    timeText = "Enter a monthly saving amount to see how long it may take to reach your target.";
  }

  document.getElementById("efTimeText").innerText = timeText;
  document.getElementById("efSummary").classList.remove("hidden");

  // Chart: current vs target
  const ctx = document.getElementById("efChart");
  if (window.efChartInstance) {
    window.efChartInstance.destroy();
  }

  window.efChartInstance = new Chart(ctx, {
    type: "bar",
    data: {
      labels: ["Current Savings", "Target Fund"],
      datasets: [{
        data: [currentSavings, target],
        backgroundColor: ["#457B9D", "#1D3557"]
      }]
    },
    options: {
      plugins: { legend: { display: false } },
      scales: {
        y: { ticks: { display: false }, grid: { display: false } },
        x: { grid: { display: false } }
      }
    }
  });
}
</script>
{% endblock %}
